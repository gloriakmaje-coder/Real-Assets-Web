# Deploy to RealAssets Production Environment
# Triggers on push to master branch
# Deploys static build to /home/thevalb9c4y6/public_html/realassets/ on Rocky Linux v8.10.0
# Served via nginx on port 3040
name: Deploy to Real Assets (Production)

on:
  push:
    branches: [ master ]

env:
  HOSTNAME: thevalua.dedicated.co.za
  USERNAME: root
  PASSWORD: ${{ secrets.SSH_PASSWORD }}
  DEPLOY_PATH: /home/thevalb9c4y6/public_html/realassets/

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      name: Checkout code
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build application
      run: npm run build
      
    - name: Verify build output
      run: ls -la build/
        
    - name: Install sshpass
      run: sudo apt-get install -y sshpass
        
    - name: Deploy to Rocky Linux server
      run: |
        echo "ðŸš€ Creating remote directory..."
        sshpass -p "${{ env.PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ env.USERNAME }}@${{ env.HOSTNAME }} "mkdir -pv ${{ env.DEPLOY_PATH }}"
        
        echo "ðŸ“¦ Deploying static build files..."
        sshpass -p "${{ env.PASSWORD }}" rsync -avz --progress --delete -e "ssh -o StrictHostKeyChecking=no" build/ ${{ env.USERNAME }}@${{ env.HOSTNAME }}:${{ env.DEPLOY_PATH }}
        
        echo "ï¿½ Reloading nginx..."
        sshpass -p "${{ env.PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ env.USERNAME }}@${{ env.HOSTNAME }} "nginx -t && systemctl reload nginx"
        
    - name: Deployment Summary
      run: |
        echo "=========================================="
        echo "  REAL ASSETS DEPLOYMENT SUMMARY"
        echo "=========================================="
        echo "Branch:           master"
        echo "Deploy Path:      ${{ env.DEPLOY_PATH }}"
        echo "Type:             Static React App"
        echo "Nginx Port:       3040"
        echo "Node Version:     20 (LTS)"
        echo "Status:           âœ… Completed"
        echo "=========================================="

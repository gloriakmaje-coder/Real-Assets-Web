# Deploy to RealAssets Production Environment
# Triggers on push to dev branch
# Deploys to /home/thevalb9c4y6/public_html/realassets/ on Rocky Linux v8.10.0
name: Deploy to Real Assets (Production)

on:
  push:
    branches: [ master ]

env:
  HOSTNAME: thevalua.dedicated.co.za
  USERNAME: root
  PASSWORD: ${{ secrets.SSH_PASSWORD }}
  DEV_DEPLOY_PATH: /home/thevalb9c4y6/public_html/realassets/

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      name: Checkout code
      
    - name: Debug - List files in repository
      run: ls -la
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '23.9.0'
        
    - name: Debug - Verify Node.js and npm
      run: |
        node -v
        npm -v
        
    - name: Install dependencies
      run: npm i

    - name: Generate Prisma client
      run: npx prisma generate
      
    - name: Debug - Verify installed dependencies
      run: npm list --depth=0
      
    - name: Build application
      run: npm run build
      
    - name: Debug - Verify build output
      run: |
        ls -la build/
        [ -d public ] && ls -la public/
        
    - name: Create deployment package
      run: |
        mkdir -p deployment
        echo "Copying files to deployment package..."
        cp -rv build/ public/ package.json package-lock.json deployment/
        [ -d app ] && echo "Copying app directory" && cp -rv app deployment/
        [ -d prisma ] && echo "Copying prisma directory" && cp -rv prisma deployment/
        
        # Copy ecosystem files but exclude .env
        echo "Copying ecosystem files..."
        [ -f ecosystem-realassets.config.js ] && cp -v ecosystem-realassets.config.js deployment/
        
        echo "Deployment package contents:"
        ls -la deployment/
        
    - name: Install sshpass for password authentication
      run: sudo apt-get install -y sshpass
        
    - name: Verify SSH connection with password
      run: |
        sshpass -p "${{ env.PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ env.USERNAME }}@${{ env.HOSTNAME }} "echo 'SSH test successful'"
        
    - name: Debug - Verify SSH setup
      run: |
        echo "Testing SSH connection with password..."
        sshpass -p "${{ env.PASSWORD }}" ssh -o StrictHostKeyChecking=no -v ${{ env.USERNAME }}@${{ env.HOSTNAME }} "echo 'SSH connection successful'; pwd"
        
    - name: Deploy to Real Assets (Production) environment
      run: |
        echo "ðŸš€ Creating remote Real Assets directory..."
        sshpass -p "${{ env.PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ env.USERNAME }}@${{ env.HOSTNAME }} "mkdir -pv ${{ env.DEV_DEPLOY_PATH}} && ls -la ${{ env.DEV_DEPLOY_PATH}}"
        
        echo "ðŸ“¦ Starting rsync to Real Assets with password authentication..."
        sshpass -p "${{ env.PASSWORD }}" rsync -avz --progress --delete --exclude='node_modules' --exclude='.env' -e "ssh -o StrictHostKeyChecking=no" deployment/ ${{ env.USERNAME }}@${{ env.HOSTNAME }}:${{ env.DEV_DEPLOY_PATH}}
        
        echo "ðŸ“¥ Installing production dependencies and generating Prisma client for Real Assets..."
        sshpass -p "${{ env.PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ env.USERNAME }}@${{ env.HOSTNAME }} "cd ${{ env.DEV_DEPLOY_PATH}} && \
          echo 'Current directory:'; pwd; \
          echo 'Files in deployment path:'; ls -la; \
          npm ci --production && \
          npx prisma generate"
        
        echo "âš¡ Starting/Restarting Real Assets application with PM2..."
        sshpass -p "${{ env.PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ env.USERNAME }}@${{ env.HOSTNAME }} "cd ${{ env.DEV_DEPLOY_PATH}} && \
          pm2 delete thevalua-dev || echo 'No existing process to delete'; \
          PORT=3099 pm2 start ecosystem-dev.config.js --env production && \
          pm2 save && \
          pm2 startup && \
          pm2 list"

    - name: Cleanup
      run: rm -rf deployment
      
    - name: Debug - Final status
      run: echo "âœ… Real Assets production deployment workflow completed with status $?"
      
    - name: Deployment Summary
      run: |
        echo "=========================================="
        echo "  REAL ASSETS PRODUCTION DEPLOYMENT SUMMARY"
        echo "=========================================="
        echo "Branch:           dev"
        echo "Environment:      Production (Real Assets)"
        echo "Deploy Path:      ${{ env.DEV_DEPLOY_PATH }}"
        echo "PM2 Process:      thevalua-dev"
        echo "Port:             3003"
        echo "Ecosystem File:   ecosystem-realassets.config.js"
        echo "Node Version:     23.9.0"
        echo "Status:           âœ… Completed"
        echo "=========================================="
